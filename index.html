<!-- Don't update me by hand, I'm generated by a program -->

<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="ANN Election Data" />
    <meta name="twitter:description" content="Raw election results, updated every five minutes using NYT data." />
    <meta name="twitter:url" content="https://frewsxcv.github.io/nyt-2020-election-scraper/battleground-state-changes.html" />
    <meta property="og:title" content="ANN Election Data" />
    <meta property="og:description" content="Raw election results, updated every five minutes using NYT data." />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-title" content="2020 Results">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó≥Ô∏è</text></svg>">
    <link rel="alternate" type="application/rss+xml" title="ANN Election Data RSS Feed" href="/nyt-2020-election-scraper/battleground-state-changes.xml" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <style>
    .table-responsive.table-responsive {
      overflow-x: unset;
    }

    .timestamp {
      min-width: 8rem;
    }

    .hurdle {
      min-width: 15rem;
    }
    
    .table td, .table th {
        padding: .25rem .5rem;
    }

    thead td {
      background-color: #e9ecef;
      line-height: 1.2rem;
    }

    thead .text-left {
        font-weight: normal;
    }

    thead span.statename {
        font-weight: bold;
        /* If changing these, update "thead tr:nth-child(2) th" too */
        font-size: 1.2rem;
        line-height: 1.2rem;
    }

    thead tr:nth-child(1) td {
        position: sticky;
        top: -1px;
        border-bottom: none;
    }

    thead tr:nth-child(2) th {
        position: sticky;
        /* Padding, first line, second line, padding */
        top: calc(.25rem + 1.2rem + 1.2rem + .25rem);
        border-right-width: 0;
        border-left-width: 0;
        border-top-width: 0;
    }
    thead tr:nth-child(2) th:first-child {
        border-left-width: 1px;
    }
    thead tr:nth-child(2) th:last-child {
        border-right-width: 1px;
    }

    tr {
        /* Fixes position: sticky headers from covering rows when deep linked, by keeping the anchor away from the top */
        scroll-margin-top: 130px;
    }

    .has-tip {
        text-decoration: underline;
        text-decoration-style: dotted;
    }

    .flag-bg {
        background-position: fixed;
        background-repeat: no-repeat;
        background-size: auto 100%;
        background-position: 100%;
    }

    .Biden{
        background-color: #84C4EE
    }
    .Trump{
        background-color: #ED98A9;
    }

    .numeric {
        text-align: right;
    }

    @media (prefers-color-scheme: dark) {
        body {
            color: #ffffff;
            background-color: #202020;
        }
        .table {
            color: #dedad6;
            background-color: #202020;
        }
        .table .thead-light th, .table .thead-light td {
            background-color: #495057;
            color: #e9ecef;
        }
        .table .thead-light th, .table td {
            border-color: #211d19;
        }
        .Biden {
            background-color: #05456F;
        }
        .Trump {
            background-color: #6E192A;
        }
    }
    </style>
    <title>Election 2020 Results</title>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.9.5/dayjs.min.js"
            integrity="sha384-I8UysxWXKTbAFvVRecMrWcGRGR4RDZ7mOuoWjMA84MWM0OQ+4IriYjgc2+hHzEo8"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.9.5/plugin/utc.js"
            integrity="sha384-PcsSBVvWDlTmn0uPlrBbd/cUxDra/qov78qWgB2Qh6TwCiXAyuJQerEmS4PoVaRQ"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.9.5/plugin/relativeTime.js"
            integrity="sha384-Dy9nN0yYkuj/yhJJITfTyN7H84joqwvGkDsyXr+JavETPnhOzTe48kfPQEI1ee0Q"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.9.5/plugin/advancedFormat.js"
            integrity="sha384-y6wn9TDoovj2ZC4/cCf+qm4Kxiha/hhqfOb/L5RThIKLYDrhcLLfTSPyyHLMM9kF"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.9.5/plugin/timezone.js"
            integrity="sha384-ABtdoJNGKT1efF9sGomlK3/sBQIhkJb0H32JGT5/7DP8H5kKBMS5mwMLu0SExhQH"
            crossorigin="anonymous"></script>

    <script type="text/javascript">
        dayjs.extend(dayjs_plugin_relativeTime)
        dayjs.extend(dayjs_plugin_utc)
        dayjs.extend(dayjs_plugin_advancedFormat)
        dayjs.extend(dayjs_plugin_timezone)

        const prettyTime = timestamp => dayjs.utc(timestamp.replace(" UTC", ""), 'YYYY-MM-DD HH:MM:SS').fromNow()
        const localTime = timestamp => dayjs.utc(timestamp.replace(" UTC", ""), 'YYYY-MM-DD HH:MM:SS').local().format('DD MMM YYYY h:mm:ss A z');

        const handleNode = node => {
            if (node.classList && node.classList.contains('timestamp')) {
                let timestamp;
                if (node.hasAttribute('data-timestamp')) {
                    timestamp = node.getAttribute('data-timestamp');
                } else {
                    timestamp = node.innerHTML;
                    node.setAttribute('data-timestamp', timestamp);
                }
                node.innerHTML = `<abbr class='pretty-timestamp' title='${localTime(timestamp)}'>${prettyTime(timestamp)}</abbr>`;
            }
        };

        new MutationObserver(mutations => {
            for (let i = 0, len = mutations.length; i < len; i++) {
                let added = mutations[i].addedNodes;
                for (let j = 0, node; (node = added[j]); j++) {
                    if (node.tagName === 'td' || node.tagName === 'span') {
                        handleNode(node);
                    } else if (node.firstElementChild) {
                        for (const child of node.querySelectorAll('td,span')) {
                            handleNode(child);
                        }
                    }
                }
            }
        }).observe(document, {
            childList: true,
            subtree: true,
        });

        setInterval(() => {
            $(".pretty-timestamp").map((_, tselem) => {
                tselem.innerText = prettyTime(tselem.parentElement.getAttribute("data-timestamp"));
            });
        }, 60 * 1000);
    </script>
</head>

<body>
<div id="body" class="container-fluid">
    <div class="row">
        <div class="col-sm">
            <p style="font-size: 1.4rem;">
                All data below is sourced from an unofficial API powering the New York Times‚Äô election site.
                <strong>The estimated votes remaining and county-level breakdown values might be off</strong>.
                Consult state websites and officials for the most accurate and up-to-date figures.
                This website is <a href="https://github.com/frewsxcv/nyt-2021-election-scraper">open source</a> and was written by <a href="https://github.com/frewsxcv/nyt-2021-election-scraper/graphs/contributors">these people</a>.
            </p>
            <p></p>
        </div>
    </div>
    <div class="row">
        <div class="col-sm">
            <p class="float-left" id="timestamps">Last scrape: <span class="timestamp">2021-11-03 03:44:36 UTC</span> | Last batch: <span class="timestamp">2021-11-03 03:44:07 UTC</span> (Virginia)</p>
            <div id="template-hash" style="display: none;">8f566dc92ebcfff8cad6704fe996e0ec7e329c1c18da9ff15f2de4850c496f7a</div>
            <div id="page-metadata" style="display: none;">{"template_hash": "8f566dc92ebcfff8cad6704fe996e0ec7e329c1c18da9ff15f2de4850c496f7a", "results_hash": "03c19d14bdafd274928b324eb98056b4575b5c4aa58a12398a174c27b50d0e6b", "states_updated": ["VA"]}</div>
        </div>
        <div class="col-sm">
            <p class="float-right">
            <button type='button' id='live_update_button' class='btn btn-secondary'>Enable Live Updates</button>
            </p>
        </div>
    </div>
    <div class="row">
        <div class="col-sm">
            <div class='table-responsive'><table id='virginia' class='table table-bordered'>

        <thead class="thead-light">
        <tr>
            <td class="text-left flag-bg" style="background-image: url('flags/virginia.svg')" colspan="9">
                <span class="has-tip" data-toggle="tooltip" title="Number of electoral votes contributed by this state and total votes by each candidate.">
                    <span class="statename">Virginia (EV: None)</span>
                </span>
                <br>
                Youngkin leads with 1,587,223 votes (51.1%), McAuliffe trails with 1,499,552 votes (48.2%).
            </td>
        </tr>
        <tr>
            <th class="has-tip" data-toggle="tooltip" title="When did this batch of votes get reported?">Timestamp</th>
            <th class="has-tip" data-toggle="tooltip" title="Which candidate currently leads this state?">In The Lead</th>
            <th class="has-tip numeric" data-toggle="tooltip" title="How many votes separate the two candidates?">Vote Margin</th>
            <th class="has-tip numeric" data-toggle="tooltip" title="Approximately how many votes are remaining to be counted? These values might be off! Consult state websites and officials for the most accurate and up-to-date figures.">Votes Remaining (est.)</th>
            <th class="has-tip numeric" data-toggle="tooltip" title="How many votes were reported in this batch, excluding third-party votes. If available, an estimated county-level breakdown is shown, but it might be inaccurate!">Change</th>
            <th class="has-tip" data-toggle="tooltip" title="How were the votes in this batch, excluding third-party votes, split between the two candidates?">Batch Breakdown</th>
            <th class="has-tip" data-toggle="tooltip" title="How has the trailing candidate's share of recent batches trended? Computed using a moving average of previous 30k votes.">Batch Trend</th>
            <th class="has-tip" data-toggle="tooltip" title="What percentage of estimated remaining votes (excluding third-party votes) does the trailing candidate need to take the lead? Since this assumes the proportion of third-party votes remains the same, this might deviate from the breakdown in batches where this is not the case.">Hurdle</th>
        </tr>
        </thead>
    

        <tr id="virginia-2021-11-03T03:44:07.054000" class="always-visible">
            <td class="timestamp">2021-11-03 03:44:07 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">87,671</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Bedford:</strong> 54%<br><strong>Campbell:</strong> 23%<br><strong>Fauquier:</strong> 22%" title="Estimated county-level breakdown: Bedford: 54%, Campbell: 23%, Fauquier: 22%">  4,103</td>
    
            <td>
                Youngkin 48.3% /
                51.7% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging  3.3%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T03:34:02.536000" class="always-visible">
            <td class="timestamp">2021-11-03 03:34:02 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">87,810</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Powhatan:</strong> 75%<br><strong>Virginia Beach:</strong> 25%" title="Estimated county-level breakdown: Powhatan: 75%, Virginia Beach: 25%">  3,596</td>
    
            <td>
                Youngkin 67.0% /
                33.0% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging  4.5%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T03:19:52.512000" class="always-visible">
            <td class="timestamp">2021-11-03 03:19:52 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">86,586</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Fauquier:</strong> 72%<br><strong>Montgomery:</strong> 17%<br><strong>Powhatan:</strong> 6%<br><strong>Amherst:</strong> 6%" title="Estimated county-level breakdown: Fauquier: 72%, Montgomery: 17%, Powhatan: 6%, Amherst: 6%"> 16,604</td>
    
            <td>
                Youngkin 134.8% /
                34.8% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging  7.8%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T03:11:32.495000" class="always-visible">
            <td class="timestamp">2021-11-03 03:11:32 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">58,438</td>
            <td class="numeric">Unknown</td>
            <td class="numeric">Unknown</td>
    
            <td>
                Youngkin  0.0% /
                100.0% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 57.8%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T03:07:22.556000" class="always-visible">
            <td class="timestamp">2021-11-03 03:07:22 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">57,538</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Prince William:</strong> 66%<br><strong>Powhatan:</strong> 22%<br><strong>Amherst:</strong> 12%<br><strong>Shenandoah:</strong> 0%" title="Estimated county-level breakdown: Prince William: 66%, Powhatan: 22%, Amherst: 12%, Shenandoah: 0%"> 25,891</td>
    
            <td>
                Youngkin 39.5% /
                60.5% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 58.3%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T03:02:42.640000" class="always-visible">
            <td class="timestamp">2021-11-03 03:02:42 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">62,955</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Virginia Beach:</strong> 100%" title="Estimated county-level breakdown: Virginia Beach: 100%">    800</td>
    
            <td>
                Youngkin 40.9% /
                59.1% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 77.2%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T03:00:42.508000" class="always-visible">
            <td class="timestamp">2021-11-03 03:00:42 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">63,101</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Virginia Beach:</strong> 54%<br><strong>Chesterfield:</strong> 46%" title="Estimated county-level breakdown: Virginia Beach: 54%, Chesterfield: 46%">  2,897</td>
    
            <td>
                Youngkin 64.6% /
                35.4% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 77.9%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:57:32.458000" class="always-visible">
            <td class="timestamp">2021-11-03 02:57:32 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">62,254</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Prince William:</strong> 71%<br><strong>Virginia Beach:</strong> 21%<br><strong>Norfolk:</strong> 6%<br><strong>Arlington:</strong> 1%<br><strong>Frederick:</strong> 0%<br><strong>Goochland:</strong> 0%" title="Estimated county-level breakdown: Prince William: 71%, Virginia Beach: 21%, Norfolk: 6%, Arlington: 1%, Frederick: 0%, Goochland: 0%"> 82,384</td>
    
            <td>
                Youngkin 17.6% /
                82.4% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 82.4%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:49:42.517000" class="always-visible">
            <td class="timestamp">2021-11-03 02:49:42 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">115,660</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Norfolk:</strong> 71%<br><strong>Chesterfield:</strong> 29%" title="Estimated county-level breakdown: Norfolk: 71%, Chesterfield: 29%">  4,978</td>
    
            <td>
                Youngkin 23.6% /
                76.4% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 57.0%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:45:12.544000" class="always-visible">
            <td class="timestamp">2021-11-03 02:45:12 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">118,288</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Chesapeake:</strong> 67%<br><strong>Stafford:</strong> 28%<br><strong>Franklin:</strong> 5%" title="Estimated county-level breakdown: Chesapeake: 67%, Stafford: 28%, Franklin: 5%"> 14,614</td>
    
            <td>
                Youngkin 42.1% /
                57.9% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 52.0%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:41:22.456000" class="always-visible">
            <td class="timestamp">2021-11-03 02:41:22 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">120,588</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Virginia Beach:</strong> 100%" title="Estimated county-level breakdown: Virginia Beach: 100%"> 56,178</td>
    
            <td>
                Youngkin 53.5% /
                46.5% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 46.5%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:36:32.389000" class="always-visible">
            <td class="timestamp">2021-11-03 02:36:32 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">116,626</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Chesapeake:</strong> 45%<br><strong>Richmond City:</strong> 28%<br><strong>Alexandria:</strong> 5%<br><strong>Prince William:</strong> 5%<br><strong>Chesterfield:</strong> 5%<br><strong>Rockbridge:</strong> 4%<br><strong>Franklin:</strong> 3%<br><strong>Suffolk:</strong> 2%<br><strong>Albemarle:</strong> 2%<br><strong>Goochland:</strong> 2%<br><strong>Warren:</strong> 0%" title="Estimated county-level breakdown: Chesapeake: 45%, Richmond City: 28%, Alexandria: 5%, Prince William: 5%, Chesterfield: 5%, Rockbridge: 4%, Franklin: 3%, Suffolk: 2%, Albemarle: 2%, Goochland: 2%, Warren: 0%"> 78,749</td>
    
            <td>
                Youngkin 39.7% /
                60.3% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 60.3%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:23:02.567000" class="always-visible">
            <td class="timestamp">2021-11-03 02:23:02 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">132,809</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Spotsylvania:</strong> 100%" title="Estimated county-level breakdown: Spotsylvania: 100%">    990</td>
    
            <td>
                Youngkin  0.0% /
                100.0% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 66.7%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:21:22.456000" class="always-visible">
            <td class="timestamp">2021-11-03 02:21:22 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">133,799</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Fairfax:</strong> 43%<br><strong>Alexandria:</strong> 16%<br><strong>Stafford:</strong> 11%<br><strong>Richmond City:</strong> 7%<br><strong>Roanoke City:</strong> 7%<br><strong>Charlottesville:</strong> 4%<br><strong>Lynchburg:</strong> 2%<br><strong>Virginia Beach:</strong> 2%<br><strong>Norfolk:</strong> 2%<br><strong>Albemarle:</strong> 2%<br><strong>Chesterfield:</strong> 1%<br><strong>Chesapeake:</strong> 1%<br><strong>Roanoke:</strong> 1%<br><strong>Prince William:</strong> 1%<br><strong>Arlington:</strong> 0%<br><strong>Dickenson:</strong> 0%<br><strong>Caroline:</strong> 0%" title="Estimated county-level breakdown: Fairfax: 43%, Alexandria: 16%, Stafford: 11%, Richmond City: 7%, Roanoke City: 7%, Charlottesville: 4%, Lynchburg: 2%, Virginia Beach: 2%, Norfolk: 2%, Albemarle: 2%, Chesterfield: 1%, Chesapeake: 1%, Roanoke: 1%, Prince William: 1%, Arlington: 0%, Dickenson: 0%, Caroline: 0%">117,017</td>
    
            <td>
                Youngkin 34.4% /
                65.6% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 65.6%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:04:52.548000" class="always-visible">
            <td class="timestamp">2021-11-03 02:04:52 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">170,332</td>
            <td class="numeric">Unknown</td>
            <td class="has-tip numeric" data-toggle="tooltip" data-html="true" data-title="<strong>Estimated county-level breakdown:</strong><br><strong>Hanover:</strong> 42%<br><strong>Alexandria:</strong> 9%<br><strong>Chesapeake:</strong> 9%<br><strong>Richmond City:</strong> 8%<br><strong>Arlington:</strong> 8%<br><strong>Roanoke City:</strong> 8%<br><strong>Charlottesville:</strong> 5%<br><strong>Prince William:</strong> 5%<br><strong>Roanoke:</strong> 5%<br><strong>Amherst:</strong> 2%" title="Estimated county-level breakdown: Hanover: 42%, Alexandria: 9%, Chesapeake: 9%, Richmond City: 8%, Arlington: 8%, Roanoke City: 8%, Charlottesville: 5%, Prince William: 5%, Roanoke: 5%, Amherst: 2%"> 38,860</td>
    
            <td>
                Youngkin 47.1% /
                52.9% McAuliffe
            </td>
        
            <td>
                McAuliffe is averaging 52.9%
            </td>
        
            <td class="hurdle">Unknown</td>
        </tr>
    

        <tr id="virginia-2021-11-03T02:03:52.525000" class="always-visible">
            <td class="timestamp">2021-11-03 02:03:52 UTC</td>
            <td class="Youngkin">Youngkin</td>
            <td class="numeric">172,586</td>
            <td class="numeric">Unknown</td>
            <td class="numeric">      0</td>
    <td>N/A</td><td>N/A</td>
            <td class="hurdle">Unknown</td>
        </tr>
    
</table></div><hr>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
    <script type="text/javascript">
        const features = {};
        const isFeatureEnabled = key => localStorage.getItem(key) === 'true';

        const feature = (key, buttonId, defaultValue, onEnable, onDisable) => {
            if (localStorage.getItem(key) == null) {
                localStorage.setItem(key, defaultValue);
            }

            const button = $(buttonId);
            button.on('click', function() {
                if (isFeatureEnabled(key)) {
                    localStorage.setItem(key, 'false');
                    onDisable(button);
                } else {
                    localStorage.setItem(key, 'true');
                    onEnable(button);
                }
            });

            if (isFeatureEnabled(key)) {
                onEnable(button);
            }

            features[key] = {
                buttonId,
                onEnable,
                onDisable
            };
        };

        const refreshFeature = key => {
            if (isFeatureEnabled(key)) {
                features[key].onEnable($(features[key].buttonId));
            } else {
                features[key].onDisable($(features[key].buttonId));
            }
        };
    </script>

    <script type="text/javascript">
        const loadTooltips = () => {
            $(function () {
                $('[data-title]').removeAttr('title');
                $('[data-toggle="tooltip"]').tooltip({ boundary: 'window' })
            })
        };
        loadTooltips();
    </script>

    <script type="text/javascript">
        // grab the latest html and return it as a Document
        const fetchLatestContent = async () => {
            const contentResponse = await fetch(location.toString(), {
                cache: 'no-cache',
            });
            const contentBody = await contentResponse.text();
            const contentDom = new DOMParser().parseFromString(contentBody, 'text/html');

            let contentMetadata;
            if (contentDom.getElementById("page-metadata")) {
                contentMetadata = JSON.parse(contentDom.getElementById("page-metadata").innerText);
            } else {
                contentMetadata = {
                    template_hash: contentDom.getElementById("template-hash").innerText,
                };
            }
            return {
                metadata: contentMetadata,
                dom: contentDom,
            }
        };

        // check if the current host is a development host
        const isDeveloperEnvironment = () => {
            return location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        };

        // if the new page has notifications, show them
        // if the new page is an updated template, hard refresh (which should get us the new page since we just loaded it)
        // otherwise, replace the div id=body element
        const updateCheck = async (currentMetadata, forceNotify) => {
            const latestContent = await fetchLatestContent();
            const latestMetadata = latestContent.metadata;
            const latestDom = latestContent.dom;
            console.log("latest content", latestContent);

            let shouldNotify = latestMetadata.states_updated.length && (
                forceNotify ||
                (currentMetadata && currentMetadata.results_hash !== latestMetadata.results_hash)
            );

            if (currentMetadata && currentMetadata.template_hash !== latestMetadata.template_hash) {
                console.log("new template, forcing reload");
                if (shouldNotify) {
                    location.hash = "notify";
                }
                location.reload(true);
                return;
            }

            if (shouldNotify && Notification.permission === "granted") {
                const notification = new Notification(`New ballots were counted in: ${latestMetadata.states_updated.join(", ")}!`);
                notification.onclick = function (event) {
                    // focus page
                    window.parent.focus();
                    // just in case, older browsers
                    window.focus();
                    // dismiss notification
                    event.target.close();
                };
            }

            $('[data-toggle="tooltip"]').tooltip('hide')

            const elementsToUpdate = [
                ...Array.from(document.getElementsByTagName("table")),
                document.getElementById("timestamps"),
            ];

            elementsToUpdate.forEach(oldElement => {
                let newElement = latestContent.dom.getElementById(oldElement.id);
                oldElement.parentNode.replaceChild(newElement, oldElement);
            });

            loadTooltips();

            return latestContent.metadata;
        };

        // do a test update
        updateCheck(undefined, location.hash === '#notify');
        location.hash = "";

        const startLiveUpdates = async () => {
            let currentMetadata = (await fetchLatestContent()).metadata;
            console.log("current content", currentMetadata);

            const nextCheck = () => {
                return isDeveloperEnvironment() ? 5 * 1000 : 60 * 1000;
            };

            const runner = async () => {
                if (!isFeatureEnabled(liveUpdatesFeature)) return;

                try {
                    currentMetadata = await updateCheck(currentMetadata, false);
                } catch (e) {
                    console.log("failed to check for updates", e);
                }
                setTimeout(runner, nextCheck());
            };

            setTimeout(runner, nextCheck());
        };

        const liveUpdatesFeature = 'live-updates';
        feature(liveUpdatesFeature, '#live_update_button', false, button => {
            button.html('Disable Live Updates');

            if ('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }

            startLiveUpdates();
        }, button => {
            button.html('Enable Live Updates');
        });
    </script>
</body>
